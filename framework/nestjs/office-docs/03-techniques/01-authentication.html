<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>身份认证 | NodeJS</title>
    <meta name="description" content="Learn Cookbook">
    
    
    <link rel="preload" href="/assets/css/0.styles.34788bb2.css" as="style"><link rel="preload" href="/assets/js/app.12ca0aa8.js" as="script"><link rel="preload" href="/assets/js/2.74bffc86.js" as="script"><link rel="preload" href="/assets/js/54.53388fc4.js" as="script"><link rel="prefetch" href="/assets/js/10.b17cd786.js"><link rel="prefetch" href="/assets/js/100.49143f76.js"><link rel="prefetch" href="/assets/js/101.58f5e966.js"><link rel="prefetch" href="/assets/js/102.0d1b5f3c.js"><link rel="prefetch" href="/assets/js/103.d2dfeb4d.js"><link rel="prefetch" href="/assets/js/104.221dfde0.js"><link rel="prefetch" href="/assets/js/105.89693a0d.js"><link rel="prefetch" href="/assets/js/106.dd9b2874.js"><link rel="prefetch" href="/assets/js/107.b128334b.js"><link rel="prefetch" href="/assets/js/108.d0fceeff.js"><link rel="prefetch" href="/assets/js/109.a36abbdb.js"><link rel="prefetch" href="/assets/js/11.3a5bf6a3.js"><link rel="prefetch" href="/assets/js/110.24de8f58.js"><link rel="prefetch" href="/assets/js/111.ad2322c5.js"><link rel="prefetch" href="/assets/js/112.ebf5a5e6.js"><link rel="prefetch" href="/assets/js/113.945153eb.js"><link rel="prefetch" href="/assets/js/114.89fb0b54.js"><link rel="prefetch" href="/assets/js/115.32747b75.js"><link rel="prefetch" href="/assets/js/116.2ac5709d.js"><link rel="prefetch" href="/assets/js/117.33f44883.js"><link rel="prefetch" href="/assets/js/118.080ca422.js"><link rel="prefetch" href="/assets/js/119.3696781e.js"><link rel="prefetch" href="/assets/js/12.49c205ea.js"><link rel="prefetch" href="/assets/js/120.8629050e.js"><link rel="prefetch" href="/assets/js/121.c541c819.js"><link rel="prefetch" href="/assets/js/122.0beeab62.js"><link rel="prefetch" href="/assets/js/123.f4aacc83.js"><link rel="prefetch" href="/assets/js/124.7b0ddfcc.js"><link rel="prefetch" href="/assets/js/125.b8173440.js"><link rel="prefetch" href="/assets/js/126.9ee9486f.js"><link rel="prefetch" href="/assets/js/127.6c6aee84.js"><link rel="prefetch" href="/assets/js/128.8100734d.js"><link rel="prefetch" href="/assets/js/129.adb74c9f.js"><link rel="prefetch" href="/assets/js/13.b12048d4.js"><link rel="prefetch" href="/assets/js/130.7dbfe596.js"><link rel="prefetch" href="/assets/js/131.a32c075c.js"><link rel="prefetch" href="/assets/js/132.6a0aa273.js"><link rel="prefetch" href="/assets/js/133.52f806e2.js"><link rel="prefetch" href="/assets/js/134.a196478b.js"><link rel="prefetch" href="/assets/js/135.83dc683e.js"><link rel="prefetch" href="/assets/js/136.e31ffd18.js"><link rel="prefetch" href="/assets/js/137.c9dbde0b.js"><link rel="prefetch" href="/assets/js/138.4d1cd5eb.js"><link rel="prefetch" href="/assets/js/139.432cf5af.js"><link rel="prefetch" href="/assets/js/14.daaf0416.js"><link rel="prefetch" href="/assets/js/140.f86409f6.js"><link rel="prefetch" href="/assets/js/141.3abe86ad.js"><link rel="prefetch" href="/assets/js/142.4f6fc92f.js"><link rel="prefetch" href="/assets/js/143.1535cab9.js"><link rel="prefetch" href="/assets/js/144.eefe99f6.js"><link rel="prefetch" href="/assets/js/145.0a2bc4ed.js"><link rel="prefetch" href="/assets/js/146.0e7b17e8.js"><link rel="prefetch" href="/assets/js/147.aecc5e52.js"><link rel="prefetch" href="/assets/js/148.55697156.js"><link rel="prefetch" href="/assets/js/149.78d2096d.js"><link rel="prefetch" href="/assets/js/15.45e9a802.js"><link rel="prefetch" href="/assets/js/150.e6c87191.js"><link rel="prefetch" href="/assets/js/151.a8009d6e.js"><link rel="prefetch" href="/assets/js/152.63d8fdec.js"><link rel="prefetch" href="/assets/js/153.3bfc0798.js"><link rel="prefetch" href="/assets/js/154.65d2ca87.js"><link rel="prefetch" href="/assets/js/155.6eeb8114.js"><link rel="prefetch" href="/assets/js/156.651636fd.js"><link rel="prefetch" href="/assets/js/157.91eccdc2.js"><link rel="prefetch" href="/assets/js/158.dbf5b9d8.js"><link rel="prefetch" href="/assets/js/159.823f0880.js"><link rel="prefetch" href="/assets/js/16.e71df8d4.js"><link rel="prefetch" href="/assets/js/160.cfed749a.js"><link rel="prefetch" href="/assets/js/161.84daf4cb.js"><link rel="prefetch" href="/assets/js/162.ceb37edb.js"><link rel="prefetch" href="/assets/js/163.d225972f.js"><link rel="prefetch" href="/assets/js/164.74f77e4a.js"><link rel="prefetch" href="/assets/js/165.e158fe5d.js"><link rel="prefetch" href="/assets/js/166.c41de610.js"><link rel="prefetch" href="/assets/js/167.7df65d3f.js"><link rel="prefetch" href="/assets/js/168.919437c8.js"><link rel="prefetch" href="/assets/js/169.9bcafe9d.js"><link rel="prefetch" href="/assets/js/17.7dc7c03f.js"><link rel="prefetch" href="/assets/js/170.f33f16fb.js"><link rel="prefetch" href="/assets/js/171.59cd7a83.js"><link rel="prefetch" href="/assets/js/172.e059a6f4.js"><link rel="prefetch" href="/assets/js/173.811a1b3e.js"><link rel="prefetch" href="/assets/js/174.e8d72986.js"><link rel="prefetch" href="/assets/js/175.3ee31f58.js"><link rel="prefetch" href="/assets/js/176.437ff1a6.js"><link rel="prefetch" href="/assets/js/177.0d04f570.js"><link rel="prefetch" href="/assets/js/178.45296cb6.js"><link rel="prefetch" href="/assets/js/179.4176b858.js"><link rel="prefetch" href="/assets/js/18.7d64b721.js"><link rel="prefetch" href="/assets/js/180.a2c20ea9.js"><link rel="prefetch" href="/assets/js/181.77390ab1.js"><link rel="prefetch" href="/assets/js/182.8ebcfdac.js"><link rel="prefetch" href="/assets/js/183.8a6b9bc8.js"><link rel="prefetch" href="/assets/js/184.a8587cd6.js"><link rel="prefetch" href="/assets/js/185.763d219b.js"><link rel="prefetch" href="/assets/js/186.d1c67c82.js"><link rel="prefetch" href="/assets/js/187.d0379152.js"><link rel="prefetch" href="/assets/js/188.3935a5a7.js"><link rel="prefetch" href="/assets/js/189.d40e35ad.js"><link rel="prefetch" href="/assets/js/19.1f322990.js"><link rel="prefetch" href="/assets/js/190.f5168c2b.js"><link rel="prefetch" href="/assets/js/191.00fd22a9.js"><link rel="prefetch" href="/assets/js/192.bb76bc33.js"><link rel="prefetch" href="/assets/js/193.0028d6ac.js"><link rel="prefetch" href="/assets/js/194.504c913a.js"><link rel="prefetch" href="/assets/js/195.6d91833a.js"><link rel="prefetch" href="/assets/js/20.520e4112.js"><link rel="prefetch" href="/assets/js/21.1da5f168.js"><link rel="prefetch" href="/assets/js/22.d42c6e1f.js"><link rel="prefetch" href="/assets/js/23.158333f0.js"><link rel="prefetch" href="/assets/js/24.4933f40a.js"><link rel="prefetch" href="/assets/js/25.057c428c.js"><link rel="prefetch" href="/assets/js/26.de289859.js"><link rel="prefetch" href="/assets/js/27.b14ef5da.js"><link rel="prefetch" href="/assets/js/28.b1329e69.js"><link rel="prefetch" href="/assets/js/29.49d46c7a.js"><link rel="prefetch" href="/assets/js/3.9fae61cb.js"><link rel="prefetch" href="/assets/js/30.83d321ec.js"><link rel="prefetch" href="/assets/js/31.65f56091.js"><link rel="prefetch" href="/assets/js/32.78fcc539.js"><link rel="prefetch" href="/assets/js/33.87e5077b.js"><link rel="prefetch" href="/assets/js/34.a4bf065f.js"><link rel="prefetch" href="/assets/js/35.b81d32e6.js"><link rel="prefetch" href="/assets/js/36.9ef245a6.js"><link rel="prefetch" href="/assets/js/37.4e2664a6.js"><link rel="prefetch" href="/assets/js/38.f8b21767.js"><link rel="prefetch" href="/assets/js/39.294b2e23.js"><link rel="prefetch" href="/assets/js/4.554dccb8.js"><link rel="prefetch" href="/assets/js/40.a35c8bd3.js"><link rel="prefetch" href="/assets/js/41.d60f7eb3.js"><link rel="prefetch" href="/assets/js/42.30f5ce46.js"><link rel="prefetch" href="/assets/js/43.101904fa.js"><link rel="prefetch" href="/assets/js/44.475772ec.js"><link rel="prefetch" href="/assets/js/45.58a6227c.js"><link rel="prefetch" href="/assets/js/46.045cad94.js"><link rel="prefetch" href="/assets/js/47.63628bb5.js"><link rel="prefetch" href="/assets/js/48.4f86f4a6.js"><link rel="prefetch" href="/assets/js/49.92a2af24.js"><link rel="prefetch" href="/assets/js/5.bfcb02d1.js"><link rel="prefetch" href="/assets/js/50.b7fd8454.js"><link rel="prefetch" href="/assets/js/51.9bbf3588.js"><link rel="prefetch" href="/assets/js/52.53f6da60.js"><link rel="prefetch" href="/assets/js/53.b415231c.js"><link rel="prefetch" href="/assets/js/55.fc24bc21.js"><link rel="prefetch" href="/assets/js/56.9b3c2535.js"><link rel="prefetch" href="/assets/js/57.ba13dd55.js"><link rel="prefetch" href="/assets/js/58.9a4c6a43.js"><link rel="prefetch" href="/assets/js/59.96e435e7.js"><link rel="prefetch" href="/assets/js/6.95fccca8.js"><link rel="prefetch" href="/assets/js/60.d17a46b6.js"><link rel="prefetch" href="/assets/js/61.0860ef3f.js"><link rel="prefetch" href="/assets/js/62.713860bc.js"><link rel="prefetch" href="/assets/js/63.38e7edcf.js"><link rel="prefetch" href="/assets/js/64.176f8bbb.js"><link rel="prefetch" href="/assets/js/65.903f4b50.js"><link rel="prefetch" href="/assets/js/66.1c5277a5.js"><link rel="prefetch" href="/assets/js/67.abfce232.js"><link rel="prefetch" href="/assets/js/68.37814697.js"><link rel="prefetch" href="/assets/js/69.c77c3c67.js"><link rel="prefetch" href="/assets/js/7.d035404c.js"><link rel="prefetch" href="/assets/js/70.742159c8.js"><link rel="prefetch" href="/assets/js/71.00f8f464.js"><link rel="prefetch" href="/assets/js/72.c8145491.js"><link rel="prefetch" href="/assets/js/73.edd94acd.js"><link rel="prefetch" href="/assets/js/74.deb52f36.js"><link rel="prefetch" href="/assets/js/75.5969aaa2.js"><link rel="prefetch" href="/assets/js/76.24433b28.js"><link rel="prefetch" href="/assets/js/77.e1a029bc.js"><link rel="prefetch" href="/assets/js/78.ec41973a.js"><link rel="prefetch" href="/assets/js/79.a8436b64.js"><link rel="prefetch" href="/assets/js/8.d1c35f37.js"><link rel="prefetch" href="/assets/js/80.70d752cd.js"><link rel="prefetch" href="/assets/js/81.5392aaa4.js"><link rel="prefetch" href="/assets/js/82.87f6938e.js"><link rel="prefetch" href="/assets/js/83.9efaf755.js"><link rel="prefetch" href="/assets/js/84.d0bba92a.js"><link rel="prefetch" href="/assets/js/85.f8f968c5.js"><link rel="prefetch" href="/assets/js/86.9e5296f6.js"><link rel="prefetch" href="/assets/js/87.8774d4bd.js"><link rel="prefetch" href="/assets/js/88.7513e6b5.js"><link rel="prefetch" href="/assets/js/89.421b5237.js"><link rel="prefetch" href="/assets/js/9.220b3eb6.js"><link rel="prefetch" href="/assets/js/90.47497ac9.js"><link rel="prefetch" href="/assets/js/91.20e7b656.js"><link rel="prefetch" href="/assets/js/92.ab742aa0.js"><link rel="prefetch" href="/assets/js/93.6f6eef2e.js"><link rel="prefetch" href="/assets/js/94.b8ff20d8.js"><link rel="prefetch" href="/assets/js/95.e97d80de.js"><link rel="prefetch" href="/assets/js/96.7f9bfe96.js"><link rel="prefetch" href="/assets/js/97.5bc5b95e.js"><link rel="prefetch" href="/assets/js/98.07280354.js"><link rel="prefetch" href="/assets/js/99.be9ded95.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34788bb2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NodeJS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/core/" class="nav-link">Node</a></div><div class="nav-item"><a href="/packageManager/" class="nav-link">Manager</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Nestjs" class="dropdown-title"><span class="title">Nestjs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/nestjs/office-docs/" class="nav-link router-link-active">NestJS 官方文档</a></li><li class="dropdown-item"><!----> <a href="/nestjs/source-codes/" class="nav-link">NestJS 源码</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="framework" class="dropdown-title"><span class="title">framework</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/egg/" class="nav-link">egg</a></li><li class="dropdown-item"><!----> <a href="/framework/express/" class="nav-link">express</a></li><li class="dropdown-item"><!----> <a href="/framework/fasitify/" class="nav-link">fasitify</a></li><li class="dropdown-item"><!----> <a href="/framework/hapi/" class="nav-link">hapi</a></li><li class="dropdown-item"><!----> <a href="/framework/koa/" class="nav-link">koa</a></li><li class="dropdown-item"><!----> <a href="/framework/midway/" class="nav-link">midway</a></li></ul></div></div><div class="nav-item"><a href="/graphql/" class="nav-link">graphql</a></div><div class="nav-item"><a href="/TypeORM/" class="nav-link">TypeORM</a></div><div class="nav-item"><a href="/branchmark/" class="nav-link">性能</a></div><div class="nav-item"><a href="/vendor/" class="nav-link">第三方包</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/core/" class="nav-link">Node</a></div><div class="nav-item"><a href="/packageManager/" class="nav-link">Manager</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Nestjs" class="dropdown-title"><span class="title">Nestjs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/nestjs/office-docs/" class="nav-link router-link-active">NestJS 官方文档</a></li><li class="dropdown-item"><!----> <a href="/nestjs/source-codes/" class="nav-link">NestJS 源码</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="framework" class="dropdown-title"><span class="title">framework</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/framework/egg/" class="nav-link">egg</a></li><li class="dropdown-item"><!----> <a href="/framework/express/" class="nav-link">express</a></li><li class="dropdown-item"><!----> <a href="/framework/fasitify/" class="nav-link">fasitify</a></li><li class="dropdown-item"><!----> <a href="/framework/hapi/" class="nav-link">hapi</a></li><li class="dropdown-item"><!----> <a href="/framework/koa/" class="nav-link">koa</a></li><li class="dropdown-item"><!----> <a href="/framework/midway/" class="nav-link">midway</a></li></ul></div></div><div class="nav-item"><a href="/graphql/" class="nav-link">graphql</a></div><div class="nav-item"><a href="/TypeORM/" class="nav-link">TypeORM</a></div><div class="nav-item"><a href="/branchmark/" class="nav-link">性能</a></div><div class="nav-item"><a href="/vendor/" class="nav-link">第三方包</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总览-OVERVIEW</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基本原理 - Fundamentals</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>技术技巧 - Techniques</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html" class="active sidebar-link">身份认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#认证要求" class="sidebar-link">认证要求</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#使用passport策略" class="sidebar-link">使用passport策略</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#在本地使用passport" class="sidebar-link">在本地使用passport</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#内置passporgraud" class="sidebar-link">内置passporgraud</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#登录路线" class="sidebar-link">登录路线</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#jwt-功能" class="sidebar-link">JWT 功能</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#实现-passport-jwt" class="sidebar-link">实现 Passport JWT</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#实现受保护的路由和jwt策略令牌" class="sidebar-link">实现受保护的路由和JWT策略令牌</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#默认策略" class="sidebar-link">默认策略</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#请求作用域策略" class="sidebar-link">请求作用域策略</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#扩展警卫" class="sidebar-link">扩展警卫</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#自定义passport" class="sidebar-link">自定义Passport</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#命令策略" class="sidebar-link">命令策略</a></li><li class="sidebar-sub-header"><a href="/framework/nestjs/office-docs/03-techniques/01-authentication.html#graphql" class="sidebar-link">GraphQL</a></li></ul></li><li><a href="/framework/nestjs/office-docs/03-techniques/02-database.html" class="sidebar-link">Data =&gt; 数据库</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/03-mongo.html" class="sidebar-link">Mongo</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/04-configuration.html" class="sidebar-link">配置 =&gt; Configuration</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/05-validation.html" class="sidebar-link">验证 =&gt; Validation</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/06-caching.html" class="sidebar-link">缓存 =&gt; Caching</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/07-serialization.html" class="sidebar-link">序列化</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/08-taskScheduling.html" class="sidebar-link">任务调度 =&gt; Task Scheduling</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/09-compression.html" class="sidebar-link">压缩 Compression</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/10-security.html" class="sidebar-link">安全</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/11-queues.html" class="sidebar-link">队列 =&gt; Queues</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/12-logger.html" class="sidebar-link">记录仪 =&gt; logger</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/13-fileUpload.html" class="sidebar-link">文件上传 =&gt; File upload</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/14-HTTPModule.html" class="sidebar-link">HTTP 模块 =&gt; HTTP module</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/15-modelViewController.html" class="sidebar-link">模型-视图-控制器 =&gt; Model-View-Controller</a></li><li><a href="/framework/nestjs/office-docs/03-techniques/16-performanceFastify.html" class="sidebar-link">性能 Performance (Fastify)</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Graphql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web 套接字</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>单 App</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>脚手架 CLI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>食谱 Recipes</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FQA</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="身份认证"><a href="#身份认证" class="header-anchor">#</a> 身份认证</h1> <p>身份认证是大多数应用程序的重要组成部分。有许多不同的方法和策略来处理身份验证。任何项目采取的方法取决于特点的应用程序要求。本章介绍了几种可以适应各种不同要求的身份验证方法。</p> <p>Passport 是最流行的node.js的身份验证库，已为社区熟知， 已成功用于许多生产应用程序中。使用该模块与Nest应用程序集成起来很简单 @nestjs/passport执行一些列步骤</p> <ul><li>通过验证用户数据”凭据“（用户名、密码， JSON Web 令牌或来自身份提供者的身份令牌)来对用户进行验证。</li> <li>管理身份验证状态（通过发出可移植的令牌（例如 JWT 或创建 Express 会员））</li> <li>将有关经过身份验证的用户的信息附加到 Request 对象， 以在路由处理程序中进一步使用。</li></ul> <p>Passport具有丰富的策略生态系统，可以实施各种身份验证机制。虽然概念上很简单，但是您可以选择的Passport策略集很大，并且存在很多变化。Passport将这些不同的步骤抽象为一个标准模式，并且该@nestjs/passport模块将该模式包装并标准化为熟悉的Nest构造。</p> <p>在本章中，我们将使用这些功能强大且灵活的模块为RESTful API服务器实现完整的端到端身份验证解决方案。您可以使用此处描述的概念来实施任何Passport策略，以自定义身份验证方案。您可以按照本章中的步骤构建完整的示例。您可以在此处找到带有完整示例应用程序的存储库。</p> <h2 id="认证要求"><a href="#认证要求" class="header-anchor">#</a> 认证要求</h2> <p>让我们充实我们的要求。对于此用例，客户端将从使用用户名和密码进行身份验证开始。一旦通过身份验证，服务器将发出JWT，该JWT可以作为承载令牌发送到后续请求证明的身份验证授权头中。我们还将创建一条受保护的路由，只有包含有效JWT的请求才能访问该路由。</p> <p>我们将从第一个要求开始：对用户进行身份验证。然后，我们将通过发布JWT扩展它。最后，我们将创建一个受保护的路由，以检查请求上的有效JWT。</p> <p>首先，我们需要安装所需的软件包。Passport提供了一种称为本地护照的策略，该策略实现了用户名/密码身份验证机制，这符合我们对用例这一部分的需求</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/passport passport passport-local
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/passport-local
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意
对于您选择的任何 Passport策略，您将始终需要@nestjs/passport和passport软件包。然后，您将需要安装特定于策略的软件包（例如passport-jwt或passport-local），该软件包将实现您正在构建的特定身份验证策略。此外，您还可以为任何Passport策略安装类型定义，如上图所示，使用@types/passport-local可以在编写TypeScript代码时提供帮助。</p></div> <h2 id="使用passport策略"><a href="#使用passport策略" class="header-anchor">#</a> 使用passport策略</h2> <p>现在，我们准备实现身份验证功能。我们将首先概述用于任何 Passport策略的过程。将Passport本身视为一个小型框架会很有帮助。该框架的优雅之处在于，它会将身份验证过程抽象为您根据要实施的策略自定义的几个基本步骤。这就像一个框架，因为您通过提供回调函数形式的自定义参数（作为纯JSON对象）和自定义代码来配置它，Passport会在适当的时候调用它。该@nestjs/passport模块将此框架包装在Nest样式包中，从而易于集成到Nest应用程序中。我们将@nestjs/passport在下面使用，但首先让我们考虑一下香草护照的工作原理。</p> <p>在Vanilla Passport中，您通过提供以下两项来配置策略：</p> <p>特定于该策略的一组选项。例如，在JWT策略中，您可以提供一个秘密来对令牌进行签名。
“验证回调”，您可以在其中告诉Passport如何与用户商店进行交互（您可以在其中管理用户帐户）。在这里，您可以验证用户是否存在（和/或创建新用户），以及他们的凭据是否有效。如果验证成功，Passport库希望此回调返回完整的用户，如果验证失败，则返回null（失败定义为找不到用户，或者在本地护照的情况下，密码不匹配） 。
使用@nestjs/passport，您可以通过扩展PassportStrategy类来配置Passport策略。您super()可以通过在子类中调用方法来传递策略选项（上述项目1），也可以选择传入options对象。您可以通过validate()在子类中实现一个方法来提供verify回调（上面的项目2）。</p> <p>我们将从生成一个，AuthModule然后在其中开始AuthService：</p> <div class="language- extra-class"><pre class="language-text"><code>$ nest g module auth
$ nest g service auth
</code></pre></div><p>在实现时AuthService，我们发现将用户操作封装在中非常有用UsersService，因此，我们现在生成该模块和服务：</p> <div class="language- extra-class"><pre class="language-text"><code>$ nest g module users
$ nest g service users
</code></pre></div><p>替换这些生成文件的默认内容，如下所示。对于我们的示例应用程序，UsersService只需维护一个硬编码的内存中用户列表，以及一个通过用户名检索一个用户的find方法。在真实的应用程序中，您可以使用选择的库（例如TypeORM，Sequelize，Mongoose等）在此处构建用户模型和持久层。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> User <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> users<span class="token operator">:</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>users <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'john'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'changeme'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'chris'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'maria'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'guess'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>username <span class="token operator">===</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>中UsersModule，唯一需要做的更改是将添加UsersService到@Module装饰器的exports数组中，以使其在此模块外部可见（我们将很快在中使用它AuthService）。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>users <span class="token operator">/</span> users<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>tsJS

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们AuthService的工作是检索用户并验证密码。validateUser()为此，我们创建了一种方法。在下面的代码中，我们使用方便的ES6传播运算符在返回用户对象之前从用户对象中删除password属性。稍后我们将通过validateUser()Passport本地策略调用该方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> usersService<span class="token operator">:</span> UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>password <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>警告
当然，在实际的应用程序中，您不会以纯文本形式存储密码。取而代之的是使用像bcrypt这样的库，它带有一种盐化的单向哈希算法。使用这种方法，您只需要存储散列密码，然后将存储的密码与输入密码的散列版本进行比较，因此永远不会以纯文本形式存储或公开用户密码。为了使我们的示例应用程序简单，我们违反了该绝对授权，并使用纯文本。不要在您的真实应用中这样做！</p></div> <p>现在，我们更新AuthModule以导入UsersModule。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// auth / auth.module.tsJS</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="在本地使用passport"><a href="#在本地使用passport" class="header-anchor">#</a> 在本地使用passport</h2> <p>现在，我们可以实施Passport 本地身份验证策略。local.strategy.ts在auth文件夹中创建一个名为的文件，并添加以下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// auth / local.strategy.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> UnauthorizedException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于所有Passport策略，我们都遵循了前面介绍的方法。在使用本地护照的用例中，没有配置选项，因此我们的构造函数仅调用super()，而没有选项对象。</p> <p>我们还实现了该validate()方法。对于每种策略，Passport都会使用一组特定validate()于@nestjs/passport策略的适当参数来调用verify函数（使用中的方法实现）。对于本地策略，Passport需要一种validate()具有以下签名的方法：validate(username: string, password:string): any。</p> <p>大部分验证工作都是在我们AuthService的帮助下完成的UserService，因此这种方法非常简单。任何 Passport策略的validate()方法都将遵循类似的模式，只是在表示凭据的方式细节上有所不同。如果找到了用户并且凭据有效，则将返回用户，以便Passport可以完成其任务（例如，在对象上创建属性），并且请求处理管道可以继续。如果找不到，我们将抛出一个异常并让我们的异常层处理它。userRequest</p> <p>通常，validate()每种策略方法的唯一显着差异是您如何确定用户是否存在并有效。例如，在JWT策略中，根据要求，我们可以评估userId已解码令牌中的进位是否与用户数据库中的记录匹配，或者与已撤销令牌的列表匹配。因此，这种子分类和实施特定于策略的验证的模式是一致，优雅且可扩展的。</p> <p>我们需要配置我们AuthModule以使用我们刚定义的Passport功能。更新auth.module.ts为如下所示：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// auth / auth.module.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersModule<span class="token punctuation">,</span> PassportModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="内置passporgraud"><a href="#内置passporgraud" class="header-anchor">#</a> 内置passporgraud</h2> <p>的卫兵章描述卫兵的主要功能：确定是否请求将被路由处理程序或处理不。事实仍然如此，我们将很快使用该标准功能。但是，在使用该@nestjs/passport模块的情况下，我们还将引入一些新的细微变化，这些细微变化一开始可能会引起混淆，所以现在让我们进行讨论。从身份验证的角度考虑，您的应用可以处于两种状态：</p> <p>用户/客户端是不登录（没有被认证）
用户/客户端已登录（已验证）
在第一种情况下（用户未登录），我们需要执行两个不同的功能：</p> <p>限制未经身份验证的用户可以访问的路由（即，拒绝访问受限制的路由）。通过将Guard放置在受保护的路由上，我们将以其熟悉的能力使用Guards来处理此功能。如您所料，我们将在此Guard中检查是否存在有效的JWT，因此，一旦我们成功发布JWT，我们便会在此Guard上进行工作。</p> <p>当先前未经身份验证的用户尝试登录时，启动身份验证步骤本身。这是我们向有效用户发出 JWT 的步骤。片刻考虑一下，我们知道我们需要POST用户名/密码凭据来启动身份验证，因此我们将设置一条POST /auth/login路径来处理该问题。这就提出了一个问题：我们究竟如何在那条路线中调用本地护照策略？</p> <p>答案很简单：使用另一种略有不同的Guard。该@nestjs/passport模块为我们提供了一个内置的Guard，可以为我们完成此任务。该Guard调用Passport策略并开始执行上述步骤（获取凭据，运行verify函数，创建user属性等）。</p> <p>上面列举的第二种情况（登录用户）仅依赖于我们已经讨论过的Guard的标准类型，以使登录用户能够访问受保护的路由。</p> <h2 id="登录路线"><a href="#登录路线" class="header-anchor">#</a> 登录路线</h2> <p>有了适当的策略，我们现在可以实施准系统/auth/login路线，并应用内置的Guard来启动护照本地流程。</p> <p>打开app.controller.ts文件，并将其内容替换为以下内容：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在扩展护照本地策略时，我们@UseGuards(AuthGuard('local'))使用的AuthGuard是@nestjs/passport自动为我们配置的。让我们分解一下。我们的Passport本地策略的默认名称为'local'。我们在@UseGuards()装饰器中引用该名称，以将其与passport-local包提供的代码关联。如果我们的应用程序中有多个Passport策略（每个策略都可能提供特定于策略的策略），这将用于消除调用哪种策略的歧义AuthGuard。到目前为止，虽然我们只有一种这样的策略，但不久之后我们将添加另一种，因此消除歧义是必需的。</p> <p>为了测试我们的路线，我们将让我们的/auth/login路线暂时返回用户。这也让我们演示了Passport的另一个功能：Passport user根据我们从validate()方法返回的值自动创建一个对象，并将其分配给该Request对象req.user。稍后，我们将其替换为代码以创建并返回JWT。</p> <p>由于这些是API路由，因此我们将使用常见的cURL库对其进行测试。您可以使用中的任何user硬编码对象进行测试UsersService。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token comment"># POST to /auth/login</span>
$ <span class="token function">curl</span> -X POST http://localhost:3000/auth/login -d <span class="token string">'{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;changeme&quot;}'</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
$ <span class="token comment"># result -&gt; {&quot;userId&quot;:1,&quot;username&quot;:&quot;john&quot;}</span>
</code></pre></div><p>在此过程中，将策略名称直接传递给AuthGuard()代码库中的魔术字符串。相反，我们建议创建自己的类，如下所示：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// auth / local-auth.guard.tsJS</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalAuthGuard</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>现在，我们可以更新/auth/login路由处理程序并使用LocalAuthGuard代替：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">UseGuards</span><span class="token punctuation">(</span>LocalAuthGuard<span class="token punctuation">)</span>
@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> req<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="jwt-功能"><a href="#jwt-功能" class="header-anchor">#</a> JWT 功能</h2> <p>我们已经准备好进入身份验证系统的JWT部分。让我们回顾并完善我们的要求：</p> <p>允许用户使用用户名/密码进行身份验证，并返回JWT以用于随后对受保护的API端点的调用。我们正在努力满足这一要求。要完成它，我们需要编写发出JWT的代码。
创建基于有效JWT作为承载令牌受到保护的API路由
我们将需要安装更多软件包来支持我们的JWT要求：</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm install @nestjs/jwt passport-jwt
$ npm install @types/passport-jwt --save-dev
</code></pre></div><p>该@nestjs/jwt软件包（请参阅此处的更多信息）是一个实用程序软件包，可帮助进行JWT操作。该passport-jwt软件包是Passport软件包，它实现JWT策略并@types/passport-jwt提供TypeScript类型定义。</p> <p>让我们仔细看看如何POST /auth/login处理请求。我们已经使用AuthGuard本地护照策略提供的内置内容来装饰路线。这意味着：</p> <p>仅当用户通过验证后，才会调用路由处理程序
该req参数将包含一个user属性（在本地护照认证流程中由Passport填充）
考虑到这一点，我们现在可以最终生成一个真实的JWT，并以这种方式返回它。为了使我们的服务保持模块化，我们将在中处理JWT的生成authService。打开auth.service.ts文件auth夹中的文件，添加login()方法，然后导入JwtService，如图所示：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>auth <span class="token operator">/</span> auth<span class="token punctuation">.</span>service<span class="token punctuation">.</span>tsJS

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> usersService<span class="token operator">:</span> UsersService<span class="token punctuation">,</span>
    <span class="token keyword">private</span> jwtService<span class="token operator">:</span> JwtService</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>password <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span> sub<span class="token operator">:</span> user<span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们正在使用该@nestjs/jwt库，该库提供了sign()根据user对象属性的子集生成JWT 的功能，然后将其作为具有单个access_token属性的简单对象返回。注意：我们选择一个属性名称sub来保持我们的userId值与JWT标准一致。不要忘记将JwtService提供程序注入AuthService。</p> <p>现在，我们需要更新，AuthModule以导入新的依赖项并配置JwtModule。</p> <p>首先，constants.ts在auth文件夹中创建，并添加以下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>auth <span class="token operator">/</span> constants<span class="token punctuation">.</span>tsJS

<span class="token keyword">export</span> <span class="token keyword">const</span> jwtConstants <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'secretKey'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们将使用它在JWT签名和验证步骤之间共享密钥。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>警告
请勿公开暴露此密钥。我们在这里这样做是为了清楚代码在做什么，但是在生产系统中，必须使用适当的措施（例如密钥库，环境变量或配置服务）
保护此密钥
。</p></div> <p>现在，auth.module.ts在auth文件夹中打开并更新它，如下所示：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>auth <span class="token operator">/</span> auth<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>tsJS

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    UsersModule<span class="token punctuation">,</span>
    PassportModule<span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们配置JwtModuleusing register()，并传入配置对象。见这里更多的巢JwtModule，并在这里对可用的配置选项的详细信息。</p> <p>现在，我们可以更新/auth/login路由以返回JWT。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalAuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>LocalAuthGuard<span class="token punctuation">)</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>让我们继续使用cURL测试我们的路线。您可以使用中的任何user硬编码对象进行测试UsersService。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token comment"># POST to /auth/login</span>
$ <span class="token function">curl</span> -X POST http://localhost:3000/auth/login -d <span class="token string">'{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;changeme&quot;}'</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
$ <span class="token comment"># result -&gt; {&quot;access_token&quot;:&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;}</span>
$ <span class="token comment"># Note: above JWT truncated</span>
</code></pre></div><h2 id="实现-passport-jwt"><a href="#实现-passport-jwt" class="header-anchor">#</a> 实现 Passport JWT</h2> <p>现在，我们可以满足我们的最终要求：通过要求请求中存在有效的JWT来保护端点。护照也可以在这里帮助我们。它提供了用于通过JSON Web令牌保护RESTful端点的password-jwt策略。首先jwt.strategy.ts在auth文件夹中创建一个名为的文件，然后添加以下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ExtractJwt<span class="token punctuation">,</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token operator">:</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromAuthHeaderAsBearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ignoreExpiration<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      secretOrKey<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> userId<span class="token operator">:</span> payload<span class="token punctuation">.</span>sub<span class="token punctuation">,</span> username<span class="token operator">:</span> payload<span class="token punctuation">.</span>username <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于我们的JwtStrategy，我们遵循了前面针对所有Passport策略所述的相同方法。该策略需要进行一些初始化，因此我们通过在super()调用中传入一个options对象来实现。您可以在此处阅读有关可用选项的更多信息。在我们的情况下，这些选项是：</p> <p>jwtFromRequest：提供从中提取JWT的方法Request。我们将使用在API请求的Authorization标头中提供承载令牌的标准方法。其他选项在此处介绍。
ignoreExpiration：为了明确起见，我们选择默认false设置，该默认设置将确保JWT尚未过期的责任委托给Passport模块。这意味着，如果为我们的路由提供了过期的JWT，则该请求将被拒绝并401 Unauthorized发送响应。Passport会为我们自动方便地处理此问题。
secretOrKey：我们使用权宜的方式是提供对称机密来对令牌进行签名。其他选项（例如，PEM编码的公共密钥）可能更适合生产应用程序（请参阅此处以获取更多信息）。在任何情况下，如前所述，请勿公开公开此秘密。
该validate()方法值得讨论。对于jwt-strategy，Passport首先验证JWT的签名并解码JSON。然后，它将调用我们的validate()方法，将解码后的JSON作为其单个参数传递。根据JWT签名的工作方式，我们可以确保我们收到的是以前签名并颁发给有效用户的有效令牌。</p> <p>所有这些的结果是，我们对validate()回调的响应是微不足道的：我们仅返回包含userId和username属性的对象。再次回想一下，Passport将user基于我们validate()方法的返回值构建一个对象，并将其作为属性附加到该Request对象上。</p> <p>还值得指出的是，这种方法给我们留出了空间（“钩子”），将其他业务逻辑注入到流程中。例如，我们可以在我们的validate()方法中进行数据库查找，以提取有关用户的更多信息，从而user在我们的中提供更丰富的对象Request。这也是我们可能决定进行进一步的令牌验证的地方，例如userId在已撤销的令牌列表中查找，从而使我们能够执行令牌吊销。我们在这里执行我们的示例代码中的模型是一种快速，“无国籍智威汤逊”模型，其中每个API调用基于有效JWT的存在会立即授权，以及有关请求者一个小一点（它userId和username）在我们的请求管道中可用。</p> <p>在中将新的添加JwtStrategy为提供者AuthModule：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>auth <span class="token operator">/</span> auth<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>tsJS

<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./jwt.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    UsersModule<span class="token punctuation">,</span>
    PassportModule<span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">,</span> JwtStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>通过导入在签名JWT时使用的相同机密，我们确保由Passport执行的验证阶段和在AuthService中执行的签署阶段均使用公共机密。</p> <p>最后，我们定义JwtAuthGuard扩展内置类的类AuthGuard：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// auth/jwt-auth.guard.tsJS</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthGuard</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="实现受保护的路由和jwt策略令牌"><a href="#实现受保护的路由和jwt策略令牌" class="header-anchor">#</a> 实现受保护的路由和JWT策略令牌</h2> <p>现在，我们可以实现我们的受保护路线及其关联的Guard。</p> <p>打开app.controller.ts文件并更新它，如下所示：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>
<span class="token comment">// app.controller.tsJS</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtAuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/jwt-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalAuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/local-auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth/auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>LocalAuthGuard<span class="token punctuation">)</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'auth/login'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>JwtAuthGuard<span class="token punctuation">)</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
  <span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> req<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再次，我们应用AuthGuard的@nestjs/passport模块自动配置为我们，当我们配置了护照，智威汤逊模块。该Guard由其默认名称引用jwt。当我们的GET /profile路线被击中时，Guard将自动调用我们的password-jwt定制配置逻辑，验证JWT，并将user属性分配给Request对象。</p> <p>确保该应用程序正在运行，并使用来测试路由cURL。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>$ # <span class="token constant">GET</span> <span class="token operator">/</span>profile
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>profile
$ # result <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">&quot;statusCode&quot;</span><span class="token operator">:</span><span class="token number">401</span><span class="token punctuation">,</span><span class="token string">&quot;error&quot;</span><span class="token operator">:</span><span class="token string">&quot;Unauthorized&quot;</span><span class="token punctuation">}</span>

$ # <span class="token constant">POST</span> <span class="token operator">/</span>auth<span class="token operator">/</span>login
$ curl <span class="token operator">-</span><span class="token constant">X</span> <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>auth<span class="token operator">/</span>login <span class="token operator">-</span>d <span class="token string">'{&quot;username&quot;: &quot;john&quot;, &quot;password&quot;: &quot;changeme&quot;}'</span> <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">&quot;Content-Type: application/json&quot;</span>
$ # result <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">&quot;access_token&quot;</span><span class="token operator">:</span>&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9<span class="token punctuation">.</span>eyJ1c2Vybm<span class="token operator">...</span> <span class="token punctuation">}</span>

$ # <span class="token constant">GET</span> <span class="token operator">/</span>profile using access_token returned <span class="token keyword">from</span> previous step <span class="token keyword">as</span> bearer code
$ curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>profile <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">&quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm...&quot;</span>
$ # result <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">&quot;userId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;john&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>请注意，在中AuthModule，我们将JWT配置为具有的到期时间60 seconds。到期时间可能太短，处理令牌到期和刷新的细节不在本文讨论范围之内。但是，我们选择该方法来证明JWT的重要质量和护照-jwt策略。如果您在通过身份验证后等待60秒再尝试GET /profile请求，则会收到401 Unauthorized响应。这是因为Passport会自动检查JWT的到期时间，从而省去了在应用程序中执行此操作的麻烦。</p> <p>现在，我们已经完成了JWT身份验证的实现。JavaScript客户端（例如Angular / React / Vue）和其他JavaScript应用程序现在可以通过我们的API服务器进行身份验证并进行安全通信。您可以在本章中找到的代码的完整版本在这里。</p> <h2 id="默认策略"><a href="#默认策略" class="header-anchor">#</a> 默认策略</h2> <p>在我们的中AppController，我们在@AuthGuard()装饰器中传递策略的名称。我们需要这样做，因为我们已经引入了两种 Passport策略（passport-local和passport-jwt），这两种策略都提供了各种Passport组件的实现。传递名称将消除我们要链接到的实现的歧义。当应用程序中包含多个策略时，我们可以声明一个默认策略，这样，@AuthGuard如果使用该默认策略，就不再需要在装饰器中传递名称。导入时，这是注册默认策略的方法PassportModule。这段代码将放在AuthModule：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jwtConstants <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./jwt.strategy'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    PassportModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> defaultStrategy<span class="token operator">:</span> <span class="token string">'jwt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      secret<span class="token operator">:</span> jwtConstants<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
      signOptions<span class="token operator">:</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token string">'60s'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    UsersModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">,</span> JwtStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="请求作用域策略"><a href="#请求作用域策略" class="header-anchor">#</a> 请求作用域策略</h2> <p>护照API基于向库的全局实例进行注册的策略。因此，策略的设计不具有依赖于请求的选项，也不是针对每个请求动态实例化的（更多有关请求范围提供者的信息）。当您将策略配置为基于请求范围时，Nest将不会实例化该策略，因为它没有绑定到任何特定的路由。没有物理方法可以确定每个请求应执行哪些“请求范围”策略。</p> <p>但是，有一些方法可以在策略内动态解析请求范围的提供程序。为此，我们利用模块参考功能。</p> <p>首先，打开local.strategy.ts文件并ModuleRef以常规方式注入</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> moduleRef<span class="token operator">:</span> ModuleRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    passReqToCallback<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>提示
的ModuleRef类是从进口@nestjs/core包。</p></div> <p>确保将passReqToCallback配置属性设置为true，如上所示。</p> <p>在下一步中，将使用请求实例获取当前上下文标识符，而不是生成一个新的标识符（在此处了解有关请求上下文的更多信息）。</p> <p>现在，在类的validate()方法内部LocalStrategy，使用类的getByRequest()方法ContextIdFactory基于请求对象创建一个上下文ID，并将其传递给resolve()调用：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>
  <span class="token parameter">request<span class="token operator">:</span> Request<span class="token punctuation">,</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> contextId <span class="token operator">=</span> ContextIdFactory<span class="token punctuation">.</span><span class="token function">getByRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// &quot;AuthService&quot; is a request-scoped provider</span>
  <span class="token keyword">const</span> authService <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleRef<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>AuthService<span class="token punctuation">,</span> contextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的示例中，该resolve()方法将异步返回AuthService提供程序的请求范围的实例（我们假设该实例AuthService被标记为请求范围的提供程序）。</p> <h2 id="扩展警卫"><a href="#扩展警卫" class="header-anchor">#</a> 扩展警卫</h2> <p>在大多数情况下，使用提供的AuthGuard类就足够了。但是，当您只想扩展默认错误处理或身份验证逻辑时，可能会有用例。为此，您可以扩展内置类并在子类中重写方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  ExecutionContext<span class="token punctuation">,</span>
  Injectable<span class="token punctuation">,</span>
  UnauthorizedException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthGuard</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">canActivate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ExecutionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add your custom authentication logic here</span>
    <span class="token comment">// for example, call super.logIn(request) to establish a session.</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> user<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// You can throw an exception based on either &quot;info&quot; or &quot;err&quot; arguments</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="自定义passport"><a href="#自定义passport" class="header-anchor">#</a> 自定义Passport</h2> <p>可以使用register()方法以相同的方式传递任何标准的Passport定制选项。可用选项取决于正在实施的策略。例如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>PassportModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> session<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>您还可以在其构造函数中向策略传递一个选项对象以对其进行配置。对于本地策略，您可以通过例如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    usernameField<span class="token operator">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
    passwordField<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看一下Passport官方网站上的财产名称。</p> <h2 id="命令策略"><a href="#命令策略" class="header-anchor">#</a> 命令策略</h2> <p>实施策略时，可以通过向PassportStrategy函数传递第二个参数来为其提供名称。如果您不这样做，则每个策略都会有一个默认名称（例如，jwt-strategy的名称为“ jwt”）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">,</span> <span class="token string">'myjwt'</span><span class="token punctuation">)</span>
</code></pre></div><p>然后，您可以通过诸如这样的装饰器来引用它@AuthGuard('myjwt')。</p> <h2 id="graphql"><a href="#graphql" class="header-anchor">#</a> GraphQL</h2> <p>为了将AuthGuard与GraphQL一起使用，请扩展内置的AuthGuard类并重写getRequest（）方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GqlAuthGuard</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ExecutionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> GqlExecutionContext<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>req<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要使用上述构造，请确保req在GraphQL Module设置中将request（）对象作为上下文值的一部分传递：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>GraphQLModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">context</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> req <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> req <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要在您的graphql解析器中获取当前经过身份验证的用户，可以定义一个@CurrentUser()装饰器：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createParamDecorator<span class="token punctuation">,</span> ExecutionContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> GqlExecutionContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> CurrentUser <span class="token operator">=</span> <span class="token function">createParamDecorator</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> context<span class="token operator">:</span> ExecutionContext</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> GqlExecutionContext<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要在解析器中使用上述装饰器，请确保将其包含为查询或变异的参数：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token parameter">returns</span> <span class="token operator">=&gt;</span> User<span class="token punctuation">)</span>
@<span class="token function">UseGuards</span><span class="token punctuation">(</span>GqlAuthGuard<span class="token punctuation">)</span>
<span class="token function">whoAmI</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/framework/nestjs/office-docs/02-fundamentals/10-testing.html" class="prev">测试中</a></span> <span class="next"><a href="/framework/nestjs/office-docs/03-techniques/02-database.html">Data =&gt; 数据库</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.12ca0aa8.js" defer></script><script src="/assets/js/2.74bffc86.js" defer></script><script src="/assets/js/54.53388fc4.js" defer></script>
  </body>
</html>
